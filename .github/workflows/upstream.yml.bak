#  
# Copyright (C) 2022 Ing <https://github.com/wjz304>  
#  
# This is free software, licensed under the MIT License.  
# See /LICENSE for more information.  
#  

name: Repo packages  

on:  
  push:  
    branches:  
      - lede  
      - openwrt  
      - immortalwrt    
  schedule:  
    - cron: '0 */6 * * *'  # 每6小时执行一次  
  workflow_dispatch: 
  watch:  
    types: started  

jobs:  
  update-packages:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id || github.event.sender.id == 71822883  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        branch: [lede, openwrt, immortalwrt]  

    steps:  
      - name: Checkout  
        uses: actions/checkout@v2  
        with:  
          ref: ${{ matrix.branch }}  

      - uses: de-vri-es/setup-git-credentials@v2  
        with:  
          credentials: https://vison-v:${{ secrets.REPO_TOKEN }}@github.com/  
    
      - name: Set git identity  
        run: |  
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  
          git config --global user.name "github-actions[bot]"  
          sudo timedatectl set-timezone "Asia/Shanghai"  

      - name: Fetch Remote Changes  
        run: |  
          git fetch origin ${{ matrix.branch }}  

      - name: Check for Updates  
        id: check_updates  
        run: |  
          LOCAL=$(git rev-parse ${{ matrix.branch }})  
          REMOTE=$(git rev-parse origin/${{ matrix.branch }})  
          if [ "$LOCAL" != "$REMOTE" ]; then  
            echo "updates=true" >> $GITHUB_ENV  
          else  
            echo "updates=false" >> $GITHUB_ENV  
          fi  

      - name: Repo packages  
        if: env.updates == 'false'  
        run: |  
          cd $GITHUB_WORKSPACE  
          if [ -f "upgrade.sh" ]; then  
            chmod +x ./upgrade.sh && ./upgrade.sh ${{ matrix.branch }}  
          else  
            curl -skL https://raw.githubusercontent.com/vison-v/packages/main/upgrade.sh | bash -s ${{ matrix.branch }}  
          fi  

      - name: Check for changes  
        if: env.updates == 'false'  
        run: |  
          if [ -n "$(git status -s | grep -v -w timestamp)" ]; then  
            echo "ischanges=true" >> $GITHUB_ENV  
          else  
            echo "ischanges=false" >> $GITHUB_ENV  
          fi  

      - name: Commit and Push  
        if: env.ischanges == 'false'  
        run: |  
          Emoji=("🎉" "🤞" "✨" "🎁" "🎈" "🎄" "🎨" "💋" "🍓" "🍕" "🍉" "💐" "🌴" "🚀" "🛸" "🗽" "⛅" "🌈" "🔥" "⛄" "🐶" "🏅" "🦄" "🐤")  
          git add .  
          git commit -m "${{ matrix.branch }} update $(date +%Y-%m-%d" "%H:%M:%S) ${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"  
          git push -f  

      # - name: Delete workflow runs  
      #   uses: Mattraks/delete-workflow-runs@v2  
      #   with:  
      #     retain_days: 1  
      #     keep_minimum_runs: 3
