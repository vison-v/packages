name: Merge-upstream  

on:  
  push:  
    branches:  
      - lede  
      - openwrt  
      - immortalwrt    
  schedule:  
    - cron: '0 */6 * * *'  # 每6小时执行一次  
  workflow_dispatch: 
    inputs:
      ssh:
        description: 'ssh'
        required: false
        default: 'false'
  watch:  
    types: started  

jobs:  
  update-packages:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id || github.event.sender.id == 71822883  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        branch: [lede, openwrt, immortalwrt]  

    steps:  
      - name: Checkout  
        uses: actions/checkout@v2  
        with:  
          ref: ${{ matrix.branch }}  

      - uses: de-vri-es/setup-git-credentials@v2  
        with:  
          credentials: https://vison-v:${{ secrets.REPO_TOKEN }}@github.com/  
    
      - name: Set git identity  
        run: |  
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  
          git config --global user.name "github-actions[bot]"  
          sudo timedatectl set-timezone "Asia/Shanghai"  
    
      - name: Fetch Remote Changes  
        run: |  
          git fetch origin ${{ matrix.branch }}  
     
      - name: Sync upstream  
        run: |  
          shopt -s extglob  
          set +e  
          git rm -r --cache * >/dev/null 2>&1 &  
          rm -rf `find ./* -maxdepth 0 -type d` >/dev/null 2>&1  
          
          function git_clone() {  
            git clone --depth 1 $1 $2  
            if [ "$?" != 0 ]; then  
              echo "error on $1"  
              pid="$( ps -q $$ )"  
              kill $pid  
            fi  
          }  
          
          function git_sparse_clone() {  
            trap 'rm -rf "$tmpdir"' EXIT  
            branch="$1"; shift  
            curl="$1"; shift  
            rootdir="$PWD"  
            tmpdir="$(mktemp -d)" || exit 1  
            if [ ${#branch} -lt 10 ]; then  
              git clone -b "$branch" --depth 1 --filter=blob:none --sparse "$curl" "$tmpdir"  
              cd "$tmpdir"  
            else  
              git clone --filter=blob:none --sparse "$curl" "$tmpdir"  
              cd "$tmpdir"  
              git checkout "$branch"  
            fi  
            if [ "$?" != 0 ]; then  
              echo "error on $curl"  
              exit 1  
            fi  
            git sparse-checkout init --cone  
            git sparse-checkout set "$@"  
            mv -n $@ "$rootdir/" || true  
            cd "$rootdir"  
          }  
          
          function mvdir() {  
            mv -n `find $1/* -maxdepth 0 -type d` ./  
            rm -rf $1  
          }  
         
          git_clone https://github.com/xiaorouji/openwrt-passwall passwall && mv -n passwall/luci-app-passwall ./; rm -rf passwall  
          git_clone https://github.com/xiaorouji/openwrt-passwall2 passwall2 && mv -n passwall2/luci-app-passwall2 ./; rm -rf passwall2  
          git_clone https://github.com/kenzok8/small && rm -rf small/{luci-app-passwall,luci-app-passwall2} && mvdir small 

          git_sparse_clone main "https://github.com/kenzok8/golang" golang            
          git_sparse_clone main "https://github.com/gdy666/luci-app-lucky" luci-app-lucky lucky  
          # 更新 lede 分支  
          if [ "${{ matrix.branch }}" == "lede" ]; then  
            git_sparse_clone master "https://github.com/openwrt/luci" applications/luci-app-ttyd applications/luci-app-smartdns
            git_sparse_clone main "https://github.com/kiddin9/kwrt-packages" luci-app-quickstart quickstart luci-app-eqosplus luci-app-oaf open-app-filter oaf luci-app-wrtbwmon wrtbwmon \
            luci-app-control-timewol luci-app-control-webrestriction luci-app-control-weburl luci-app-wechatpush luci-theme-argon luci-app-argon-config 
         
          # 更新 openwrt 分支  
          elif [ "${{ matrix.branch }}" == "openwrt" ]; then  
            git_sparse_clone master "https://github.com/immortalwrt/immortalwrt" package/emortal/default-settings  
            git_sparse_clone main "https://github.com/kiddin9/kwrt-packages" luci-app-quickstart quickstart luci-app-eqosplus luci-app-oaf open-app-filter oaf luci-app-vlmcsd vlmcsd \
            luci-app-control-timewol luci-app-control-webrestriction luci-app-control-weburl  luci-app-wechatpush luci-theme-argon luci-app-argon-config luci-app-zerotier \
            luci-app-unblockneteasemusic UnblockNeteaseMusic luci-app-syncdial luci-app-tcpdump luci-app-socat luci-app-samba4 luci-app-cifs-mount
         
          # 更新 immortalwrt 分支  
          elif [ "${{ matrix.branch }}" == "immortalwrt" ]; then  
            git_sparse_clone main "https://github.com/kiddin9/kwrt-packages.git" luci-app-eqosplus luci-app-tcpdump luci-app-control-webrestriction luci-app-control-weburl
          fi  
          
      - name: Language Management  
        run: |  
         if ls -d luci-app-*/po > /dev/null 2>&1; then  
           for dir in luci-app-*/po; do  
             ls -d "$dir"/*/ | grep -v '/zh-cn/' | grep -v '/zh_Hans/' | xargs rm -rf
           done
            for e in $(ls -d luci-app-*/po); do
              if [[ -d $e/zh-cn &&! -d $e/zh_Hans ]]; then
                cp -rf $e/zh-cn $e/zh_Hans 2>/dev/null
              elif [[ -d $e/zh_Hans &&! -d $e/zh-cn ]]; then
                cp -rf $e/zh_Hans $e/zh-cn 2>/dev/null
              fi
            done
         fi       
     
      - name: Apply Changes  
        run: |  
          Emoji=("🎉" "🤞" "✨" "🎁" "🎈" "🎄" "🎨" "💋" "🍓" "🍕" "🍉" "💐" "🌴" "🚀" "🛸" "🗽" "⛅" "🌈" "🔥" "⛄" "🐶" "🏅" "🦄" "🐤")  
          git add .  
          git commit -m "${Emoji[$RANDOM % ${#Emoji[@]}]} Sync $(date +%Y-%m-%d" "%H:%M:%S)" || echo "No changes to commit"    
          git push -f
       
      - name: SSH connection to Actions
        uses: kiddin9/debugger-action@master
        if: github.event.inputs.ssh == 'true'
     
      - name: Delete workflow runs  
        uses: Mattraks/delete-workflow-runs@main  
        continue-on-error: true  
        with:  
          retain_days: 2  
          keep_minimum_runs: 4
