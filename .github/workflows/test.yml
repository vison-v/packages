name: Merge-upstream-test  

on:  
  push:  
    branches:  
      - lede  
      - openwrt  
      - immortalwrt    
  schedule:  
    - cron: '0 */6 * * *'  # 每6小时执行一次  
  workflow_dispatch:   
    inputs:  
      ssh:  
        description: 'Enable SSH connection'  
        required: false  
        default: 'false'  
  watch:  
    types: started  

jobs:  
  update-packages:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id || github.event.sender.id == 71822883  
    runs-on: ubuntu-latest  
    strategy:  
      matrix:  
        branch: [lede, openwrt, immortalwrt]  

    steps:  
      - name: Checkout  
        uses: actions/checkout@v2  
        with:  
          ref: ${{ matrix.branch }}  

      - uses: de-vri-es/setup-git-credentials@v2  
        with:  
          credentials: https://vison-v:${{ secrets.REPO_TOKEN }}@github.com/  

      - name: Set git identity  
        run: |  
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  
          git config --global user.name "github-actions[bot]"  
          sudo timedatectl set-timezone "Asia/Shanghai"  

      - name: Fetch Remote Changes  
        run: |  
          git fetch origin ${{ matrix.branch }}  

      - name: Sync upstream  
        run: ./sync_upstream.sh ${{ matrix.branch }}  
        shell: bash  

      - name: Language Management  
        run: |  
          if ls -d luci-app-*/po > /dev/null 2>&1; then  
            for dir in luci-app-*/po; do  
              ls -d "$dir"/*/ | grep -v '/zh-cn/' | grep -v '/zh_Hans/' | xargs rm -rf  
            done  
            for e in $(ls -d luci-app-*/po); do  
              if [[ -d $e/zh-cn && ! -d $e/zh_Hans ]]; then  
                cp -rf $e/zh-cn $e/zh_Hans 2>/dev/null  
              elif [[ -d $e/zh_Hans && ! -d $e/zh-cn ]]; then  
                cp -rf $e/zh_Hans $e/zh-cn 2>/dev/null  
              fi  
            done  
          fi       

      - name: Apply Changes  
        run: |  
          Emoji=("🎉" "🤞" "✨" "🎁" "🎈" "🎄" "🎨" "💋" "🍓" "🍕" "🍉" "💐" "🌴" "🚀" "🛸" "🗽" "⛅" "🌈" "🔥" "⛄" "🐶" "🏅" "🦄" "🐤")  
          git add .  
          git commit -m "${Emoji[$RANDOM % ${#Emoji[@]}]} Sync $(date +%Y-%m-%d" "%H:%M:%S)" || echo "No changes to commit"    
          git push -f  

      - name: SSH connection to Actions  
        uses: kiddin9/debugger-action@master  
        if: github.event.inputs.ssh == 'true'  

      - name: Delete workflow runs  
        uses: Mattraks/delete-workflow-runs@main  
        continue-on-error: true  
        with:  
          retain_days: 2  
          keep_minimum_runs: 4
